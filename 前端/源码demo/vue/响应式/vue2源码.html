<div id="app">
  <h3></h3>
</div>

<script>
  function observe(obj) {
    //监视obj中的所有属性
    Object.keys(obj).forEach((key) => {
      defineReactive(obj, key, obj[key]);
    });
  }
  function defineReactive(obj, key, val) {
    //属性拦截
    Object.defineProperty(obj, key, {
      get() {
        console.log("get", key);
        return val;
      },
      set(v) {
        if (v !== val) {
          console.log("set", key);
          val = v;
          //通知更新,一般不可能名字是这个，采用依赖更新
          myApp.update();
        }
      },
    });
  }
  //1.vue构造函数
  //2.给vue实例添加一个$mount方法
  function Vue(options) {
    //初始化
    //1.数据响应式
    this.$options = options;
    this.$data = options.data();
    //对$data对象做响应式处理
    observe(this.$data);
  }
  Vue.prototype.$mount = function (selector) {
    //挂载,将数据转化为dom
    //1.视图首次初始化
    this.update = function () {
      console.log("update");
      //重新执行渲染函数
      const child = this.$options.render.call(this);
      //获取宿主
      const parent = document.querySelector(selector);
      //区分是初始化还是更新
      if (!this.isMounted) {
        //init
        parent.appendChild(child);
        this.isMounted = true;
        //生命周期
        if (this.$options.mounted) {
          this.$options.mounted.call(this);
        }
      } else {
        //update
        parent.innerText = "";
        parent.appendChild(child);
      }
    };
    this.update();
  };
  const myApp = new Vue({
    data() {
      return {
        title: "这是一个标题",
      };
    },
    mounted() {
      setTimeout(() => {
        this.$data.title = "这是新的标题";
      }, 1000);
    },
    render() {
      //渲染视图
      //vue2渲染函数返回的是虚拟dom
      //这里暂时返回真实的dom
      const h3 = document.createElement("h3");
      h3.innerText = this.$data.title;
      return h3;
    },
  });
  myApp.$mount("#app");
  myApp.$data.title;
</script>
