<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>canvas</title>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js"></script>

    <style>
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -o-user-select: none;
            user-select: none;
        }

        .box {
            display: flex;
            margin-top: 50px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -o-user-select: none;
            user-select: none;
        }

        .canvas-box {
            -webkit-user-select: none;
            -moz-user-select: none;
            -o-user-select: none;
            user-select: none;
            width: 700px;
            height: 1000px;
            position: relative;
            overflow: hidden;
        }

        .elm {
            -webkit-user-select: none;
            -moz-user-select: none;
            -o-user-select: none;
            user-select: none;
            position: absolute;
            left: 0;
            top: 0;
            border: 1px solid red;
        }
    </style>
</head>

<body>
    <div class="box">
        <div class="canvas-box">
            <canvas id="canvas" width="500" height="600"></canvas>
        </div>

        <div class="box-btn">
            <input type="file" value="select img" value="选择图片" class="file">
            <input type="button" id="save" value="保存">
        </div>
        <img class="img" style="display: none;"></img>
    </div>
</body>
<script type="text/javascript">
    //定义
    imgSrc = ''

    function pauseEvent(e) {
        if (e.stopPropagation) e.stopPropagation();
        if (e.preventDefault) e.preventDefault();
        e.cancelBubble = true;
        e.returnValue = false;
        return false;
    }

    function getObjectURL(file) {
        var url = null;
        if (window.createObjcectURL != undefined) {
            url = window.createOjcectURL(file);
        } else if (window.URL != undefined) {
            url = window.URL.createObjectURL(file);
        } else if (window.webkitURL != undefined) {
            url = window.webkitURL.createObjectURL(file);
        }
        return url;
    }
    if (window.FileReader) {
        var reader = new FileReader();
    } else {
        console.log('你的浏览器不支持读取文件');
    }
    //选择图像
    window.onload = function () {
        $(".file").change(function () {
            imgFile = $(this)[0].files[0]
            if (!/image\/\w+/.test(imgFile.type)) {
                alert("文件必须为图片！");
                return false;
            }
            var objURL = getObjectURL(imgFile);
            //$(".img").attr("src",objURL)
            var reader = new FileReader();
            reader.readAsDataURL(this.files[0]);
            reader.onload = function (e) {
                console.log(e, imgFile)
            }
            $(".canvas-box").html("<canvas id='canvas' width='500' height='600'></canvas>")
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            var img = new Image()
            // img.src = objURL;
            img.src = './01.jpg'
            var cw = $("canvas").width()
            var ch = $("canvas").height()

            function drawImage() {
                img.onload = function () {
                    imgW = img.width / 4
                    imgH = img.height / 4
                    console.log(imgW, imgH)

                    imgX = (cw - imgW) / 2
                    //drawImage前4个是定义图像源的切片位置和大小，后4个则是定义切片的目标显示位置和大小。
                    ctx.drawImage(this, 0, 0, imgW, imgH);
                    //ctx.drawImage(document.getElementById('img'), imgX, 0, imgW, imgH);
                }
            }
            drawImage()
            canvas.onmousedown = function (e) {
                console.log(21)
            }
        })
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        var img = new Image()
        // img.src = objURL;
        img.src = './01.jpg'
        var cw = $("canvas").width()
        var ch = $("canvas").height()

        function drawImage() {
            
            img.onload = function () {
                imgW = img.width / 4
                imgH = img.height / 4
                console.log(imgW, imgH)

                imgX = (cw - imgW) / 2
                //drawImage前4个是定义图像源的切片位置和大小，后4个则是定义切片的目标显示位置和大小。
                ctx.drawImage(this, 0, 0, imgW, imgH);
                //ctx.drawImage(document.getElementById('img'), imgX, 0, imgW, imgH);
            }
        }
        drawImage()
        status = []

        var clientRect = canvas.getBoundingClientRect();
        var obj = {};
        $("#canvas").on("mousedown", function (ev) {
            pauseEvent(ev)
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            var e = ev || event;
            e.stopPropagation();
            var x = e.offsetX + clientRect.left;
            var y = e.offsetY + clientRect.top;
            obj[0] = [x, y]
            var status = true
            console.log(1)
            if (status) {
                $("#canvas").on("mousemove", function (e) {
                    pauseEvent(e)
                    e.stopPropagation();
                    var ax = e.offsetX + clientRect.left;
                    var ay = e.offsetY + clientRect.top;
                    //console.log(event.offsetX)
                    // 计算移动距离
                    var xDistance = Math.abs(x - ax);
                    var yDistance = Math.abs(y - ay);
                    $(".elm").remove()
                    $(".canvas-box").append("<div class='elm'></div>")

                    $(".elm").width(xDistance).height(yDistance)
                    document.getElementsByClassName("elm")[0].style.marginLeft = x + 'px'
                    document.getElementsByClassName("elm")[0].style.marginTop = x + 'px'
                    console.log(x, y)
                    console.log(document.getElementsByClassName("elm")[0].style.width);
                })
            } else {
                e.stopPropagation();
                $("#canvas").unbind("mousemove", null);
            }


        })


        $("#canvas").on("mouseup", function (e) {
            e.stopPropagation();
            //document.getElementsByClassName("elm")[0].style.left = obj[0][0] + 'px'
            // document.getElementsByClassName("elm")[0].style.top = x + 'px'
            $("#canvas").unbind("mousemove", null);
            console.log('up');
            status = false
        })

    }
</script>

</html>