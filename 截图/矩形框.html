<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>鼠标拖动绘制矩形框(canvas)</title>
</head>

<body>

    <canvas id="canvas" width="600" height="300" style="border: 1px solid #000;"></canvas>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js"></script>
    <script src="./jcanvas.min.js"></script>
    <script>
        function getObjectURL(file) {
            var url = null;
            if (window.createObjcectURL != undefined) {
                url = window.createOjcectURL(file);
            } else if (window.URL != undefined) {
                url = window.URL.createObjectURL(file);
            } else if (window.webkitURL != undefined) {
                url = window.webkitURL.createObjectURL(file);
            }
            return url;
        }
        if (window.FileReader) {
            var reader = new FileReader();
        } else {
            console.log('你的浏览器不支持读取文件');
        }
        //选择图像
        window.onload = function () {
            $(".file").change(function () {
                imgFile = $(this)[0].files[0]
                if (!/image\/\w+/.test(imgFile.type)) {
                    alert("文件必须为图片！");
                    return false;
                }
                var objURL = getObjectURL(imgFile);
                //$(".img").attr("src",objURL)
                var reader = new FileReader();
                reader.readAsDataURL(this.files[0]);
                reader.onload = function (e) {
                    console.log(e, imgFile)
                }

                var canvas = document.getElementById('canvas');
                var ctx = canvas.getContext('2d');
                var img = new Image()
                // img.src = objURL;
                img.src = './01.jpg'
                var cw = $("canvas").width()
                var ch = $("canvas").height()

                function drawImage() {
                    img.onload = function () {
                        imgW = img.width / 4
                        imgH = img.height / 4
                        console.log(imgW, imgH)

                        imgX = (cw - imgW) / 2
                        //drawImage前4个是定义图像源的切片位置和大小，后4个则是定义切片的目标显示位置和大小。
                        ctx.drawImage(this, 0, 0, imgW, imgH);
                        //ctx.drawImage(document.getElementById('img'), imgX, 0, imgW, imgH);
                    }
                }
                drawImage()

            })
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            var img = new Image()
            // img.src = objURL;
            img.src = './01.jpg'
            var cw = $("canvas").width()
            var ch = $("canvas").height()

            function drawImage() {
                img.onload = function () {
                    imgW = img.width / 4
                    imgH = img.height / 4
                    console.log(imgW, imgH)

                    imgX = (cw - imgW) / 2
                    //drawImage前4个是定义图像源的切片位置和大小，后4个则是定义切片的目标显示位置和大小。
                    ctx.drawImage(this, 0, 0, imgW, imgH);
                    //ctx.drawImage(document.getElementById('img'), imgX, 0, imgW, imgH);
                }
            }
            drawImage()

        }

        var layer = 0;

        function drawRect(canvasId, penColor, strokeWidth) {
            var that = this;
            that.penColor = penColor;
            that.penWidth = strokeWidth;
            var canvas = document.getElementById(canvasId);
            //canvas 的矩形框
            var canvasRect = canvas.getBoundingClientRect();
            //矩形框的左上角坐标
            var canvasLeft = canvasRect.left;
            var canvasTop = canvasRect.top;
            console.log(canvasLeft)
            var layerIndex = layer;
            var layerName = "layer";
            var x = 0;
            var y = 0;

            //鼠标点击按下事件，画图准备
            canvas.onmousedown = function (e) {
                //设置画笔颜色和宽度
                var color = that.penColor;
                var penWidth = that.penWidth;

                layerIndex++;
                layer++;
                layerName += layerIndex;
                console.log(layerIndex, layer, layerName)

                x = e.clientX - canvasLeft;
                y = e.clientY - canvasTop;

                $("#" + canvasId).addLayer({
                    type: 'rectangle',
                    strokeStyle: color,
                    strokeWidth: penWidth,
                    name: layerName,
                    fromCenter: false,
                    x: x,
                    y: y,
                    width: 1,
                    height: 1
                });

                $("#" + canvasId).drawLayers();
                $("#" + canvasId).saveCanvas();
                //鼠标移动事件，画图
                canvas.onmousemove = function (e) {
                    width = e.clientX - canvasLeft - x;
                    height = e.clientY - canvasTop - y;

                    $("#" + canvasId).removeLayer(layerName);

                    $("#" + canvasId).addLayer({
                        type: 'rectangle',
                        strokeStyle: color,
                        strokeWidth: penWidth,
                        name: layerName,
                        fromCenter: false,
                        x: x,
                        y: y,
                        width: width,
                        height: height
                    });

                    $("#" + canvasId).drawLayers();
                }
            };

            canvas.onmouseup = function (e) {

                var color = that.penColor;
                var penWidth = that.penWidth;

                canvas.onmousemove = null;

                width = e.clientX - canvasLeft - x;
                height = e.clientY - canvasTop - y;

                $("#" + canvasId).removeLayer(layerName);

                $("#" + canvasId).addLayer({
                    type: 'rectangle',
                    strokeStyle: color,
                    strokeWidth: penWidth,
                    name: layerName,
                    fromCenter: false,
                    x: x,
                    y: y,
                    width: width,
                    height: height
                });

                $("#" + canvasId).drawLayers();
                $("#" + canvasId).saveCanvas();
            }
        }

        function drawPen() {
            var color = "red";
            var width = 1;
            drawRect("canvas", color, width);
        }
        drawPen();
    </script>
</body>

</html>